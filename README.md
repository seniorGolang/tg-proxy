# tg-proxy

–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–∞ Go –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞–∫–µ—Ç–æ–≤ –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (GitLab, GitHub –∏ –¥—Ä—É–≥–∏—Ö) —á–µ—Ä–µ–∑ –∫–æ—Ä–æ—Ç–∫–∏–µ –∞–ª–∏–∞—Å—ã. –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∏ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∏—Ö –∫ –≤–Ω–µ—à–Ω–∏–º API, –≤–æ–∑–≤—Ä–∞—â–∞—è –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ URL.

> **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–∞ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞ [tg](https://github.com/seniorGolang/tg) –∏ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö.

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- üîå **–ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** ‚Äî –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ–º–∞—è —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
- üîê **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** ‚Äî —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
- ‚ö° **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚Äî –ø–æ—Ç–æ–∫–æ–≤–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ —Ñ–∞–π–ª–æ–≤ –∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- üîÑ **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏** ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ GitLab, GitHub –∏ –¥—Ä—É–≥–∏—Ö —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- üíæ **–ì–∏–±–∫–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ** ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ MongoDB –∏ SQL –±–∞–∑ (PostgreSQL, SQLite, MySQL, SQL Server) —á–µ—Ä–µ–∑ GORM
- üåê **HTTP API** ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `net/http` –∏ `go-fiber`
- üîë **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** ‚Äî —Ä–∞–∑–¥–µ–ª—å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –∏ –∞–¥–º–∏–Ω—Å–∫–∏—Ö —Ä–æ—É—Ç–æ–≤

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Go 1.25 –∏–ª–∏ –≤—ã—à–µ

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
go get github.com/seniorGolang/tg-proxy
```

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```go
package main

import (
	"log/slog"
	"net/http"
	"os"

	"github.com/seniorGolang/tg-proxy"
	"github.com/seniorGolang/tg-proxy/cache/memory"
	"github.com/seniorGolang/tg-proxy/core"
	"github.com/seniorGolang/tg-proxy/encryption/aes"
	"github.com/seniorGolang/tg-proxy/helpers"
	"github.com/seniorGolang/tg-proxy/source/gitlab"
	"github.com/seniorGolang/tg-proxy/storage/mongo"
)

func main() {

	helpers.SetupLogger(helpers.ParseLogLevel(os.Getenv("LOG_LEVEL")))

	mongoURI := os.Getenv("MONGO_URI")
	proxyPort := os.Getenv("PROXY_PORT")
	proxyBaseURL := os.Getenv("PROXY_BASE_URL")
	encryptionKey := os.Getenv("ENCRYPTION_KEY")
	gitlabBaseURL := os.Getenv("GITLAB_BASE_URL")

	key := aes.DeriveKeyFromString(encryptionKey)
	aesEncryptor, err := aes.NewEncryptor(key)
	helpers.Must(err, "Failed to create encryptor")

	mongoStorage, err := mongo.NewRepository(mongoURI)
	helpers.Must(err, "Failed to connect to MongoDB")

	memoryCache := memory.NewCache()

	engine := core.NewEngine(
		core.Storage(mongoStorage),
		core.Encryptor(aesEncryptor),
		core.Cache(memoryCache),
	)

	gitlabSource := gitlab.NewClient(gitlabBaseURL)
	helpers.Must(engine.RegisterSource(gitlabSource), "Failed to register source")

	proxy := tgproxy.New(engine, proxyBaseURL)

	mux := http.NewServeMux()
	proxy.SetPublicRoutes(mux, "/")
	proxy.SetAdminRoutes(mux, "/api/v1")

	slog.Info("Starting HTTP server",
		slog.String("port", proxyPort),
		slog.String("baseURL", proxyBaseURL),
	)

	helpers.Must(http.ListenAndServe(":"+proxyPort, mux), "Server failed")
}
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö –º–æ–¥—É–ª—å–Ω–æ—Å—Ç–∏ –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç–∏:

- **Core Engine** ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É—é—â–∏–π —Ä–∞–±–æ—Ç—É –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- **Project Resolver** ‚Äî —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∞–ª–∏–∞—Å–æ–≤ –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–æ–π —Ç–æ–∫–µ–Ω–æ–≤
- **Manifest Transformer** ‚Äî —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ —Å –∑–∞–º–µ–Ω–æ–π URL –Ω–∞ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ:
    - –ó–∞–º–µ–Ω–∞ URL —Ñ–∞–π–ª–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏ (`downloads`) –Ω–∞ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ URL
    - –ó–∞–º–µ–Ω–∞ URL –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ (`manifests`) –Ω–∞ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ URL
    - –ó–∞–º–µ–Ω–∞ URL –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å–∫—Ä–∏–ø—Ç–æ–≤ (`scripts.source`) –Ω–∞ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ URL
    - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (`dependencies`) —Å –ø–æ–∏—Å–∫–æ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –∑–∞–º–µ–Ω–æ–π –Ω–∞ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ URL
- **Source Interface** ‚Äî –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –ø–∞–∫–µ—Ç–æ–≤
- **Storage Interface** ‚Äî –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞–º–∏
- **Encryptor Interface** ‚Äî –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- **Cache Interface** ‚Äî –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

## –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤

–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –ø—Ä–∏ –∏—Ö –ø–æ–ª—É—á–µ–Ω–∏–∏, –∑–∞–º–µ–Ω—è—è –≤—Å–µ URL –Ω–∞ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ:

### –û–±—Ä–∞–±–æ—Ç–∫–∞ URL —Ñ–∞–π–ª–æ–≤ –∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤

–í—Å–µ URL —Ñ–∞–π–ª–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏ (`packages[].downloads[].url`), —Å—Å—ã–ª–æ–∫ –Ω–∞ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã (`manifests[].url`) –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å–∫—Ä–∏–ø—Ç–æ–≤ (`packages[].scripts.*.source`) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–º–µ–Ω—è—é—Ç—Å—è –Ω–∞ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ URL, –µ—Å–ª–∏ –æ–Ω–∏ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç –¥–æ–º–µ–Ω—É –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞.

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø–∞–∫–µ—Ç–æ–≤ (`packages[].dependencies[]`):

1. **–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π** ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã:
    - `package` ‚Äî –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –±–µ–∑ –≤–µ—Ä—Å–∏–∏
    - `package@version` ‚Äî –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —Å –≤–µ—Ä—Å–∏–µ–π
    - `source:package` ‚Äî –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –∏–∑ –¥—Ä—É–≥–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –±–µ–∑ –≤–µ—Ä—Å–∏–∏
    - `source:package@version` ‚Äî –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –∏–∑ –¥—Ä—É–≥–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Å –≤–µ—Ä—Å–∏–µ–π
    - `URL:package@version` ‚Äî –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –∏–∑ URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `https://github.com/user/repo:package@1.0.0`)

2. **–ü–æ–∏—Å–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤** ‚Äî –¥–ª—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Å URL –∏—Å—Ç–æ—á–Ω–∏–∫–∞:
    - URL –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è (—É–¥–∞–ª—è–µ—Ç—Å—è —Å—É—Ñ—Ñ–∏–∫—Å `.git`, –µ—Å–ª–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
    - –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–∏—Å–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –Ω–∞–π–¥–µ–Ω, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π URL: `{baseURL}/{alias}:{package}@{version}` –∏–ª–∏ `{baseURL}/{alias}:{package}`

3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π** ‚Äî –µ—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç URL –∏—Å—Ç–æ—á–Ω–∏–∫–∞, –æ–Ω–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–ü—Ä–∏–º–µ—Ä —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:**

```yaml
# –ò—Å—Ö–æ–¥–Ω—ã–π –º–∞–Ω–∏—Ñ–µ—Å—Ç
packages:
  - name: mypackage
    dependencies:
      - https://github.com/user/repo:mypackage@1.0.0
      - otherpackage@2.0.0
      - github:somepackage@1.5.0

# –ü–æ—Å–ª–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–µ—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç —Å repo_url="https://github.com/user/repo" –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —Å alias="user-repo")
packages:
  - name: mypackage
    dependencies:
      - http://proxy:8080/user-repo:mypackage@1.0.0  # –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π URL
      - otherpackage@2.0.0                          # –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–Ω–µ—Ç URL –∏—Å—Ç–æ—á–Ω–∏–∫–∞)
      - github:somepackage@1.5.0                    # –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–Ω–µ URL, –∞ –∏–º—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞)
```

### –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è: —É–¥–∞–ª—è–µ—Ç—Å—è —Å—É—Ñ—Ñ–∏–∫—Å `.git`, –µ—Å–ª–∏ –æ–Ω –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø–æ–∏—Å–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤ –ø–æ URL –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

**–ü—Ä–∏–º–µ—Ä:**

- –í—Ö–æ–¥–Ω–æ–π URL: `https://github.com/user/repo.git`
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π URL: `https://github.com/user/repo`

## API

### –ü—É–±–ª–∏—á–Ω—ã–µ —Ä–æ—É—Ç—ã

–ü—É–±–ª–∏—á–Ω—ã–µ —Ä–æ—É—Ç—ã –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞–º –∏ —Ñ–∞–π–ª–∞–º:

```
GET /{prefix}/{alias}/{version}/manifest.yml     - –ø–æ–ª—É—á–µ–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞
GET /{prefix}/{alias}/{version}/*                 - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
GET /{prefix}/{alias}/versions                            - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤–µ—Ä—Å–∏–π
```

**–ü—Ä–∏–º–µ—Ä—ã:**

```bash
# –ü–æ–ª—É—á–µ–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞
curl -H "X-API-Key: public-key" \
  http://localhost:8080/api/v1/proxy/myproject/1.0.25/manifest.yml

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
curl -H "X-API-Key: public-key" \
  http://localhost:8080/api/v1/proxy/myproject/1.0.25/package.tar.gz

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤–µ—Ä—Å–∏–π
curl -H "X-API-Key: public-key" \
  http://localhost:8080/api/v1/proxy/myproject/versions
```

### –ê–¥–º–∏–Ω—Å–∫–∏–µ —Ä–æ—É—Ç—ã

–ê–¥–º–∏–Ω—Å–∫–∏–µ —Ä–æ—É—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞–º–∏:

```
GET    /{prefix}/projects           - —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤ (—Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π)
POST   /{prefix}/projects           - —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
GET    /{prefix}/projects/{alias}   - –ø–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
PUT    /{prefix}/projects/{alias}   - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
DELETE /{prefix}/projects/{alias}   - —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
```

**–ü—Ä–∏–º–µ—Ä—ã:**

```bash
# –°–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤
curl -H "X-Admin-Key: admin-key" \
  "http://localhost:8080/api/v1/admin/projects?limit=10&offset=0"

# –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
curl -X POST -H "X-Admin-Key: admin-key" \
  -H "Content-Type: application/json" \
  -d '{
    "alias": "myproject",
    "repo_url": "https://gitlab.com/foo/bar",
    "token": "glpat-xxxxxxxxxxxxxxxxxxxx",
    "description": "My project",
    "source_name": "gitlab"
  }' \
  http://localhost:8080/api/v1/admin/projects

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
curl -H "X-Admin-Key: admin-key" \
  http://localhost:8080/api/v1/admin/projects/myproject

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
curl -X PUT -H "X-Admin-Key: admin-key" \
  -H "Content-Type: application/json" \
  -d '{
    "repo_url": "https://gitlab.com/foo/bar-new",
    "description": "Updated description"
  }' \
  http://localhost:8080/api/v1/admin/projects/myproject

# –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
curl -X DELETE -H "X-Admin-Key: admin-key" \
  http://localhost:8080/api/v1/admin/projects/myproject
```

## –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–∑–¥–µ–ª—å–Ω—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –∏ –∞–¥–º–∏–Ω—Å–∫–∏—Ö —Ä–æ—É—Ç–æ–≤. –î–æ—Å—Ç—É–ø–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —Ç–∏–ø–æ–≤—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–∑ –ø–∞–∫–µ—Ç–∞ `helpers`:

### –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–ª—é—á (API Key)

```go
publicAuth := helpers.NewStaticKeyAuth("public-key", "X-API-Key")
adminAuth := helpers.NewStaticKeyAuth("admin-key", "X-Admin-Key")
```

### HTTP Basic Authentication

```go
publicAuth := helpers.NewBasicAuth("public-user", "public-pass")
adminAuth := helpers.NewBasicAuth("admin-user", "admin-pass")
```

### JWT —Å RSA –ø–æ–¥–ø–∏—Å—å—é

```go
publicAuth, err := helpers.NewJWTAuth(publicKeyPEM)
adminAuth, err := helpers.NewJWTAuth(adminKeyPEM)
```

–í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, —Ä–µ–∞–ª–∏–∑–æ–≤–∞–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã `AuthProvider` –∏–ª–∏ `FiberAuthProvider`.

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å go-fiber

–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ç–∞–∫–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å `go-fiber`:

```go
import (
	"github.com/gofiber/fiber/v2"
	tgproxy "github.com/seniorGolang/tg-proxy"
)

app := fiber.New()

proxy := tgproxy.New(engine, "https://proxy.example.com",
	tgproxy.PublicAuth(publicAuth),
	tgproxy.AdminAuth(adminAuth),
)

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–æ—É—Ç–æ–≤
proxy.SetPublicRoutesFiber(app, "/api/v1/proxy")
proxy.SetAdminRoutesFiber(app, "/api/v1/admin")

app.Listen(":8080")
```

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞

–†–µ–∞–ª–∏–∑—É–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `core.Source`:

```go
type Source interface {
	Name() (name string)
	GetManifest(ctx context.Context, project domain.Project, version string) (manifest domain.Manifest, err error)
	GetFileStream(ctx context.Context, project domain.Project, version string, filename string) (stream io.ReadCloser, err error)
	GetFileResponse(ctx context.Context, project domain.Project, version string, filename string) (resp *http.Response, err error)
	GetVersions(ctx context.Context, project domain.Project) (versions []string, err error)
}
```

–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `core.SourceInfo` –¥–ª—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö:

```go
type SourceInfo interface {
	BaseURL() (url string)
}
```

–ó–∞—Ç–µ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫:

```go
customSource := NewCustomSource(...)
engine.RegisterSource(customSource)
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

–†–µ–∞–ª–∏–∑—É–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `core.Storage` (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–∑ –ø–∞–∫–µ—Ç–∞ `storage`):

```go
type Storage interface {
	GetProject(ctx context.Context, alias string) (project domain.Project, found bool, err error)
	GetProjectByRepoURL(ctx context.Context, repoURL string) (project domain.Project, found bool, err error)
	CreateProject(ctx context.Context, project domain.Project) (err error)
	UpdateProject(ctx context.Context, alias string, project domain.Project) (err error)
	DeleteProject(ctx context.Context, alias string) (err error)
	ListProjects(ctx context.Context, limit int, offset int) (projects []domain.Project, total int64, err error)
}
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ú–µ—Ç–æ–¥ `GetProjectByRepoURL` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤ –ø–æ URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞—Ö.

–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
- `storage/mongo` ‚Äî MongoDB —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- `storage/gorm` ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è SQL –±–∞–∑ (PostgreSQL, SQLite, MySQL, SQL Server)

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —à–∏—Ñ—Ä–∞—Ç–æ—Ä–∞

–†–µ–∞–ª–∏–∑—É–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `core.Encryptor` (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å):

```go
type Encryptor interface {
	EncryptString(plaintext string) (ciphertext string, err error)
	DecryptString(ciphertext string) (plaintext string, err error)
}
```

–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
- `encryption/aes` ‚Äî AES —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–µ—à–∞

–†–µ–∞–ª–∏–∑—É–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `core.Cache` (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å):

```go
type Cache interface {
	GetProject(ctx context.Context, alias string) (project domain.Project, found bool, err error)
	SetProject(ctx context.Context, alias string, project domain.Project, ttl time.Duration) (err error)
	DeleteProject(ctx context.Context, alias string) (err error)
	GetVersions(ctx context.Context, alias string) (versions []string, found bool, err error)
	SetVersions(ctx context.Context, alias string, versions []string, ttl time.Duration) (err error)
	Clear(ctx context.Context) (err error)
}
```

–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
- `cache/memory` ‚Äî in-memory –∫–µ—à
- `cache/redis` ‚Äî Redis –∫–µ—à

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞–∫–µ—Ç `log/slog`. –í—Å–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏–∏ `slog.String()`, `slog.Int()`, `slog.Duration()`, `slog.Any()` –∏ —Ç.–¥.

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞:**

```go
import (
	"log/slog"
	"github.com/seniorGolang/tg-proxy/helpers"
)

helpers.SetupLogger(helpers.ParseLogLevel(os.Getenv("LOG_LEVEL")))
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ:**

```go
import "log/slog"

slog.Info("Starting server",
	slog.Int("port", 8080),
	slog.String("env", "production"),
)

slog.Error("Failed to connect",
	slog.Any("error", err),
	slog.String("uri", dbURI),
)
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
tg-proxy/
‚îú‚îÄ‚îÄ api/                    # API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ swagger.json        # OpenAPI 3.0 —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îú‚îÄ‚îÄ cache/                  # –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–µ—à–∞
‚îÇ   ‚îú‚îÄ‚îÄ memory/            # In-memory –∫–µ—à
‚îÇ   ‚îî‚îÄ‚îÄ redis/             # Redis –∫–µ—à
‚îú‚îÄ‚îÄ core/                   # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ cache.go           # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–µ—à–∞
‚îÇ   ‚îú‚îÄ‚îÄ encryptor.go       # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —à–∏—Ñ—Ä–∞—Ç–æ—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ engine.go          # Core Engine
‚îÇ   ‚îú‚îÄ‚îÄ resolver.go        # Project Resolver
‚îÇ   ‚îú‚îÄ‚îÄ source.go          # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ storage.go         # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
‚îÇ   ‚îî‚îÄ‚îÄ transformer.go     # Manifest Transformer
‚îú‚îÄ‚îÄ encryption/             # –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ aes/               # AES —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
‚îú‚îÄ‚îÄ errs/                   # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫
‚îú‚îÄ‚îÄ helpers/                # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ auth.go            # –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ errors.go          # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
‚îÇ   ‚îú‚îÄ‚îÄ logger.go          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ logkeys.go         # –ö–ª—é—á–∏ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ mask.go            # –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ url.go             # –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è URL
‚îÇ   ‚îî‚îÄ‚îÄ validator.go       # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ model/                  # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ converter.go       # –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä—ã –º–æ–¥–µ–ª–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ domain/            # –î–æ–º–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ dto/               # DTO –º–æ–¥–µ–ª–∏ –¥–ª—è API
‚îÇ   ‚îî‚îÄ‚îÄ manifest.go        # –ú–æ–¥–µ–ª—å –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞
‚îú‚îÄ‚îÄ source/                 # –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ gitlab/            # GitLab Source Implementation
‚îÇ   ‚îî‚îÄ‚îÄ github/            # GitHub Source Implementation
‚îú‚îÄ‚îÄ storage/                # –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
‚îÇ   ‚îú‚îÄ‚îÄ gorm/              # GORM —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (PostgreSQL, SQLite, MySQL, SQL Server)
‚îÇ   ‚îî‚îÄ‚îÄ mongo/             # MongoDB —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
‚îú‚îÄ‚îÄ auth.go                # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ engine.go              # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å Engine –¥–ª—è Proxy
‚îú‚îÄ‚îÄ handlers.go            # HTTP –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îú‚îÄ‚îÄ middleware.go          # Middleware –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ proxy.go               # –û—Å–Ω–æ–≤–Ω–æ–π Proxy –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
‚îî‚îÄ‚îÄ routes.go              # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–æ—É—Ç–æ–≤
```

## –õ–∏—Ü–µ–Ω–∑–∏—è

–°–º. —Ñ–∞–π–ª [LICENSE](LICENSE) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.

## –í–∫–ª–∞–¥

–í–∫–ª–∞–¥ –≤ –ø—Ä–æ–µ–∫—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç—Å—è! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ issue –∏–ª–∏ pull request –¥–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ —É–ª—É—á—à–µ–Ω–∏—é.

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–û—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ñ–∞–π–ª–µ `README.md`. API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ OpenAPI 3.0 –≤ —Ñ–∞–π–ª–µ `api/swagger.json`.
